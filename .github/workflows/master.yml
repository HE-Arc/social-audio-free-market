name: Django & Nuxt.js CI/CD

on:
  push:
    branches: [ master, dev ]
  pull_request:
    branches: [ master, dev ]

jobs:

  Django:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        python-version: [3.6, 3.7]

    services:
      mysql: mysql:5.7
      env:
        MYSQL_ROOT_PASSWORD: password
      ports:
        - 33306:3306
      options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Verify MySQL connection from host
      run: |
        sudo apt-get install -y mysql-client
        mysql --host 127.0.0.1 --port 33306 -uroot -ppassword -e "SHOW DATABASES"
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v1
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install Linux packages
      run: |
        sudo apt-get install libsndfile-dev
        sudo apt-get install sox
    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    - name: Run migrations
      env:
        SECRET_KEY: vx!u6*+=51d+79t0%!#5#-b06fev1f*x80uvm_@c2a6ko_!mbt
        DJANGO_SETTINGS_MODULE: safm.settings.production
        DB_PASSWORD: password
        DB_NAME: mysql
      run: |
        cd src
        python manage.py migrate
    - name: Run Tests
      env:
        SECRET_KEY: vx!u6*+=51d+79t0%!#5#-b06fev1f*x80uvm_@c2a6ko_!mbt
        DJANGO_SETTINGS_MODULE: safm.settings.production
        DB_PASSWORD: password
        DB_NAME: mysql
      run: |
        cd src
        python manage.py test

  Nuxt:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
      matrix:
        node-version: [12.x]

    steps:
    - uses: actions/checkout@v2
    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v1
      with:
        node-version: ${{ matrix.node-version }}
    - name: Install npm dependencies
      run: |
        cd src/safm_nuxt
        npm install
    - name: Nuxt Linter
      run: |
        cd src/safm_nuxt
        npm run lint
    - name: Test Nuxt application
      run: |
        cd src/safm_nuxt
        npm test
    - name: Build Nuxt application
      env:
        NUXT_APP_MODE: spa
      run: |
        cd src/safm_nuxt
        npm run build
